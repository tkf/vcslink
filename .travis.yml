sudo: false
language: python
dist: xenial  # required for Python >= 3.7

python:
  - "3.7"

env:
  global:
    - TOXENV=py

before_install:
  - pip install --quiet "pip>=19.0"
  - pip install --quiet tox coveralls

script:
  - tox

after_success:
  - coveralls

matrix:
  include:

    # This is somehow required to run the "default" job:
    - env:
        - TOXENV=py

    - &check
      env:
        - TOXENV=style
      script:
        - tox
      after_success: skip
    - <<: *check
      env:
        - TOXENV=type
    - <<: *check
      env:
        - TOXENV=docs

    # Upload the package to `test.pypi.org` when there is a push to
    # `release/test` branch:
    - stage: "Test deploy"
      deploy:
        provider: pypi
        server: https://test.pypi.org/legacy/
        user: tkf
        password:
          secure: dv1uQN0Hsjb+aqm11C2nrDYd/jJfm1u0J/CmeoiLLzfL/dzDoBizQXv3xH1vEgZIEPawcYAGinq8nbJy4LSt50j+rKw/Ie+qYrqMbIyKueSF6fA4oDUMRs30R5WuWptDyaGuJmMsj7BdElnfsY1w44MuQ6B+S5RjYv19bH5SLmd6fRnHj15QIXGNu1JhRk6p6vohtQBXR8DreEEYgX+OcG1Z3QeXFNGCdLDFCSQscOzVs5nLvJvavfMN/0/zVKh1iu9Qi+Ks3J4sAVQqJAEewRnDPLl5nYuM7MnuIU3LZTrolyp82aGeuIaDeY4tlPD3HAawYNwWEXr2enZZT90E/T9Paboa79A/F7ApjT10fWD3qlajbbNFwFfj6iq3E8kYLjLY947GTaHHatAcA0ZMjJIWlB1n3iBKWV3KYNNUbi+11VnC97KzmkQ7DaVyVWLOyVTQs8+o4wGC8m0uURb9RiP+FNuLddC/rbt7x61IsrmKSO9Jlu8kb0J4JzxiaXt9AXi7vrM0ZDIlJ+yiv2Tkpqr1VMTo5562Ep51ZhB2Tf2v2+eQRU60spuZmSDFpk/fVioq1JWtY7P6hrSQ6aZ+gLGyC+6nD9QEUQiNWtWjI7KsGLbSDQlKZEo+DhiuAphreS+zJcYC9PtYb5J5IDJkGdKxaV5MRY5N44mntX4WZtc=
        distributions: "sdist bdist_wheel"
        on:
          branch: release/test
          repo: tkf/vcslinks
      if: branch = release/test
      script: skip
      after_success:
        - echo "skipped"
        # Do not use `after_success: skip` as it would skip the deploy
        # step.
        # https://github.com/travis-ci/travis-ci/issues/8337#issuecomment-326838809

    # Test uploaded package
    - stage: "Test upload"
      if: branch = release/test OR branch = upload/test
      script:
        - cd ci/test-upload && tox
      after_success: skip

notifications:
  email: false
